<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RocketMQ</title>
    <meta name="description" content="VitePress">
    <link rel="stylesheet" href="/vitepress-deploy/assets/style.c6a8f29c.css">
    <link rel="modulepreload" href="/vitepress-deploy/assets/app.2a154df8.js">
    <link rel="modulepreload" href="/vitepress-deploy/assets/src_view_java_java-15-rocketmq.md.2983da5e.lean.js">
    
    <link rel="icon" href="https://cn.vitejs.dev/logo-with-shadow.png">
  <script>(()=>{const e=localStorage.getItem("vitepress-theme-appearance"),a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-581d5782><!--[--><!--]--><!--[--><span tabindex="-1" data-v-2c02b834></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-2c02b834> Skip to content </a><!--]--><!----><header class="VPNav no-sidebar" data-v-581d5782 data-v-119e663c><div class="VPNavBar" data-v-119e663c data-v-1f7b674d><div class="container" data-v-1f7b674d><div class="VPNavBarTitle" data-v-1f7b674d data-v-ed531ba2><a class="title" href="/vitepress-deploy/" data-v-ed531ba2><!--[--><img class="VPImage logo" src="https://cn.vitejs.dev/logo-with-shadow.png" data-v-81172f9c><!--]--><!--[-->首页<!--]--></a></div><div class="content" data-v-1f7b674d><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-1f7b674d data-v-192c109a><span id="main-nav-aria-label" class="visually-hidden" data-v-192c109a>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/vitepress-deploy/src/view/index.html" data-v-192c109a data-v-4d31877c data-v-8dd034e6><!--[-->问答<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/vitepress-deploy/src/web/index.html" data-v-192c109a data-v-4d31877c data-v-8dd034e6><!--[-->前端<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/vitepress-deploy/src/deploy/index.html" data-v-192c109a data-v-4d31877c data-v-8dd034e6><!--[-->部署<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/vitepress-deploy/src/kit/index.html" data-v-192c109a data-v-4d31877c data-v-8dd034e6><!--[-->工具<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/vitepress-deploy/src/case/index.html" data-v-192c109a data-v-4d31877c data-v-8dd034e6><!--[-->案例<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-1f7b674d data-v-5cf7609e><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" data-v-5cf7609e data-v-766c3cb1 data-v-d6dfd774><span class="check" data-v-d6dfd774><span class="icon" data-v-d6dfd774><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-766c3cb1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-766c3cb1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-1f7b674d data-v-a767cbbe data-v-e03f590e><!--[--><a class="VPSocialLink" href="https://github.com/space2030?tab=repositories" title="github" target="_blank" rel="noopener noreferrer" data-v-e03f590e data-v-3dd9970c><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-3dd9970c><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg><span class="visually-hidden" data-v-3dd9970c>github</span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-1f7b674d data-v-6a32f7d6 data-v-44cec2e6><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-44cec2e6><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-44cec2e6><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-44cec2e6><div class="VPMenu" data-v-44cec2e6 data-v-ddb22576><!----><!--[--><!--[--><!----><div class="group" data-v-6a32f7d6><div class="item appearance" data-v-6a32f7d6><p class="label" data-v-6a32f7d6>Appearance</p><div class="appearance-action" data-v-6a32f7d6><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" data-v-6a32f7d6 data-v-766c3cb1 data-v-d6dfd774><span class="check" data-v-d6dfd774><span class="icon" data-v-d6dfd774><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-766c3cb1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-766c3cb1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-6a32f7d6><div class="item social-links" data-v-6a32f7d6><div class="VPSocialLinks social-links-list" data-v-6a32f7d6 data-v-e03f590e><!--[--><a class="VPSocialLink" href="https://github.com/space2030?tab=repositories" title="github" target="_blank" rel="noopener noreferrer" data-v-e03f590e data-v-3dd9970c><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-3dd9970c><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg><span class="visually-hidden" data-v-3dd9970c>github</span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-1f7b674d data-v-3524c702><span class="container" data-v-3524c702><span class="top" data-v-3524c702></span><span class="middle" data-v-3524c702></span><span class="bottom" data-v-3524c702></span></span></button></div></div></div><!----></header><!----><!----><div class="VPContent" id="VPContent" data-v-581d5782 data-v-804f35da><div class="VPDoc" data-v-804f35da data-v-3886f8ec><div class="container" data-v-3886f8ec><div class="aside" data-v-3886f8ec><div class="aside-curtain" data-v-3886f8ec></div><div class="aside-container" data-v-3886f8ec><div class="aside-content" data-v-3886f8ec><div class="VPDocAside" data-v-3886f8ec data-v-a4f49d12><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline has-outline" data-v-a4f49d12 data-v-2d325df8><div class="content" data-v-2d325df8><div class="outline-marker" data-v-2d325df8></div><div class="outline-title" data-v-2d325df8>目录</div><nav aria-labelledby="doc-outline-aria-label" data-v-2d325df8><span class="visually-hidden" id="doc-outline-aria-label" data-v-2d325df8> Table of Contents for current page </span><ul class="root" data-v-2d325df8><!--[--><li style="" data-v-2d325df8><a class="outline-link" href="#概念" data-v-2d325df8>概念</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#mq-作用" data-v-2d325df8>MQ 作用</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#rocketmq-角色作用" data-v-2d325df8>RocketMQ 角色作用</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#topic-和-queue-的区别" data-v-2d325df8>Topic 和 queue 的区别</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#broker-中消息被消费后会立即删除吗" data-v-2d325df8>Broker 中消息被消费后会立即删除吗</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#rocketmq-角色" data-v-2d325df8>RocketMQ 角色</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#rocketmq-broker-中消息被消费后会立即删除吗" data-v-2d325df8>RocketMQ Broker 中消息被消费后会立即删除吗</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#rocketmq-消费模式" data-v-2d325df8>RocketMQ 消费模式</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#消费消息是-push-还是-pull" data-v-2d325df8>消费消息是 push 还是 pull</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#rocketmq-分布式事务" data-v-2d325df8>RocketMQ 分布式事务</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#优化生产者和消费者的性能" data-v-2d325df8>优化生产者和消费者的性能</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#rocketmq-是如何保证数据高容错" data-v-2d325df8>RocketMQ 是如何保证数据高容错</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#broker-突然宕机" data-v-2d325df8>Broker 突然宕机</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#broker-将自己的信息注册到哪个-nameserver-上" data-v-2d325df8>Broker 将自己的信息注册到哪个 NameServer 上</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#消息堆积" data-v-2d325df8>消息堆积</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#堆积时间过长消息超时了" data-v-2d325df8>堆积时间过长消息超时了</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#死信队列" data-v-2d325df8>死信队列</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#默认端口" data-v-2d325df8>默认端口</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#每个消息至少投递一次" data-v-2d325df8>每个消息至少投递一次</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#回溯消息" data-v-2d325df8>回溯消息</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#定时消息" data-v-2d325df8>定时消息</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#消息重试" data-v-2d325df8>消息重试</a><!----></li><li style="" data-v-2d325df8><a class="outline-link" href="#mq-性能优化" data-v-2d325df8>MQ 性能优化</a><!----></li><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-a4f49d12></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-3886f8ec><div class="content-container" data-v-3886f8ec><!--[--><!--]--><main class="main" data-v-3886f8ec><div style="position:relative;" class="vp-doc _vitepress-deploy_src_view_java_java-15-rocketmq" data-v-3886f8ec><div><h1 id="rocketmq" tabindex="-1">RocketMQ <a class="header-anchor" href="#rocketmq" aria-hidden="true">#</a></h1><h1 id="rocketmq-1" tabindex="-1">RocketMQ <a class="header-anchor" href="#rocketmq-1" aria-hidden="true">#</a></h1><h2 id="概念" tabindex="-1">概念 <a class="header-anchor" href="#概念" aria-hidden="true">#</a></h2><p>java 开发、面向互联网集群化功能丰富，对在线业务的响应时延做了很多优化，大多数情况下不可以做到毫秒级的响应，每秒钟大概能处理几十万条消息。</p><h2 id="mq-作用" tabindex="-1">MQ 作用 <a class="header-anchor" href="#mq-作用" aria-hidden="true">#</a></h2><ul><li>项目比较大时，做了分布式系统，所有远程服务调用请求都是同步执行经常出问题 <ul><li>解耦：系统耦合度降低，没有强依赖关系</li><li>异步：不需要同步执行的远程调用可以有效提高响应时间。</li><li>削峰：请求达到峰值后，后端 service 还可以保持固定消费速率消费，不会被压垮</li></ul></li></ul><h2 id="rocketmq-角色作用" tabindex="-1">RocketMQ 角色作用 <a class="header-anchor" href="#rocketmq-角色作用" aria-hidden="true">#</a></h2><p>Nameserver</p><ul><li>无状态、动态列表，对比：zk是有状态的</li></ul><p>Producer</p><ul><li>消费生产者，负责发消息到 Broker</li></ul><p>Broker</p><ul><li>MQ本身，负责收发消息，持久化消息</li></ul><p>Consumer</p><ul><li>消息消费者，负责从 Broker 上拉取消息进行消费，消费完进行 ack</li></ul><h2 id="topic-和-queue-的区别" tabindex="-1">Topic 和 queue 的区别 <a class="header-anchor" href="#topic-和-queue-的区别" aria-hidden="true">#</a></h2><ol><li>queue 就是来源于数据结构的 FIFO 队列</li><li>Topic 是个抽象的概念，每个 Topic 底层对应 N 个 Queue，而数据也真实存在 queue 上的。</li></ol><h2 id="broker-中消息被消费后会立即删除吗" tabindex="-1">Broker 中消息被消费后会立即删除吗 <a class="header-anchor" href="#broker-中消息被消费后会立即删除吗" aria-hidden="true">#</a></h2><ol><li>不会，每条消息都会持久化到 CommitLog 中，每个 Consumer 连接到 Broker 后会维持消费进度信息，</li><li>当有消息消费后只是当前 Consumer 的消费进度更新了，也就是 CommitLog 的 offset 更新了。</li></ol><h2 id="rocketmq-角色" tabindex="-1">RocketMQ 角色 <a class="header-anchor" href="#rocketmq-角色" aria-hidden="true">#</a></h2><ol><li>Nameserver 无状态，动态列表，zk 是有状态</li><li>Producer 消息生产者，负责发消息到 broker</li><li>Broker 就是 MQ 本身，负责收发消息，持久化消息等</li><li>Consumer 消息消费者，负责从 Broker 上拉取消息进行消费，消费完进行 ack</li></ol><h2 id="rocketmq-broker-中消息被消费后会立即删除吗" tabindex="-1">RocketMQ Broker 中消息被消费后会立即删除吗 <a class="header-anchor" href="#rocketmq-broker-中消息被消费后会立即删除吗" aria-hidden="true">#</a></h2><ol><li>不会，每条消息都会持久化到 CommitLog 中，每个 Consumer 连接到 Broker 后会维持消费进度信息。</li><li>当有消息消费后只是当前 Consumer 的消费进度（CommitLog 的 offset）更新了</li></ol><blockquote><p>会不会涉及消费堆积？什么时候清理过期消息</p></blockquote><ol><li>检查这个文件最后访问时间</li><li>判断是否大于过期时间</li><li>指定时间删除，默认凌晨 4 点</li></ol><h2 id="rocketmq-消费模式" tabindex="-1">RocketMQ 消费模式 <a class="header-anchor" href="#rocketmq-消费模式" aria-hidden="true">#</a></h2><p>消费模型由 Consumer 决定，消费维度为 Topic</p><ul><li>集群消费</li></ul><ol><li>一条消息只会被同 Group 中的一个 Consumer 消费</li><li>多个 Group 同时消费一个 Topic 时，每个 Group 都会有一个 Consumer 消费到数据</li></ol><ul><li>广播消费</li></ul><ol><li>消息将对一个 Consumer Group 下的各个 Consumer 实例都消费一遍，即使这些 Consumer 属于同一个 Consumer Group</li><li>消息也会被 Consumer Group 中的每个 Consumer 都消费一次。</li></ol><h2 id="消费消息是-push-还是-pull" tabindex="-1">消费消息是 push 还是 pull <a class="header-anchor" href="#消费消息是-push-还是-pull" aria-hidden="true">#</a></h2><ol><li>RocketMQ 没有真正意义的 push 都是 pull 虽然有 push 类，但实例底层实现采用的 长轮询机制，即拉取方式</li><li>broker 端属性 longPollingEnable 标记是否开启长轮询，默认开启</li></ol><blockquote><p>为什么要主动拉取消息而不使用事件监听方式？</p></blockquote><p>事件驱动方式是建立好长连接，由事件（发送数据）的方式来实时推送</p><ul><li>如果 broker 主动推送消息的话有可能 push 速度快，消费速度慢的情况，那么就会造成消息在 consumer 端堆积过多， 同时又不能被其他 consumer 消费的情况，而 pull 的方式可以根据当前自身情况来 pull， 不会造成过多的压力而造成瓶颈，所以采取了 pull 的方式。</li></ul><h2 id="rocketmq-分布式事务" tabindex="-1">RocketMQ 分布式事务 <a class="header-anchor" href="#rocketmq-分布式事务" aria-hidden="true">#</a></h2><p>使用 TCC 保证消息到达分布式事务的最终一致性</p><ol><li>Half Message <ol><li>预处理消息，当 broker 收到此类消息后，会存储到 RMQ_SYS_TRANS_HALF_TOPIC 的消息消费队列中</li></ol></li><li>检查事务状态 <ol><li>Broker 会开启一个定时任务，消费 RMQ_SYS_TRANS_HALF_TOPIC 队列中的消息， 每次执行任务会向消息发送者确认事务执行状态（提交、回滚、未知），如果是未知， Broker 会定时去回调在重新检查。</li></ol></li><li>超时 <ol><li>如果超过回查次数，默认回滚消息</li><li>也就是它未真正进入 Topic 的queue，而是用了临时 queue 来放 Half Message ， 等提交事务后，才会真正的将 Half Message 转移到 Topic 下的queue</li></ol></li></ol><h2 id="优化生产者和消费者的性能" tabindex="-1">优化生产者和消费者的性能 <a class="header-anchor" href="#优化生产者和消费者的性能" aria-hidden="true">#</a></h2><ol><li>同一个 group 下，多机部署，并行消费</li><li>单个 Consumer 提高消费线程个数</li><li>批量消费（消息批量拉取、业务逻辑批量处理）</li></ol><h2 id="rocketmq-是如何保证数据高容错" tabindex="-1">RocketMQ 是如何保证数据高容错 <a class="header-anchor" href="#rocketmq-是如何保证数据高容错" aria-hidden="true">#</a></h2><ol><li>在不开启容错的情况下，轮询队列进行发送，如果失败了，重试的时候过滤失败的 Broker</li><li>如果开启了容错策略，会通过 RocketMQ 的预测机制来预测一个 Broker 是否可用</li><li>如果上次失败的 Broker 可用那么还是会选择该 Broker 的队列</li><li>如果上述情况失败，则随机选择一个进行发送</li><li>在发送消息的时候会记录一下调用的时间与是否报错，根据该时间去预测 broker 的可用时间</li></ol><h2 id="broker-突然宕机" tabindex="-1">Broker 突然宕机 <a class="header-anchor" href="#broker-突然宕机" aria-hidden="true">#</a></h2><ol><li>主从架构以及多副本策略</li><li>Master 收到消息后会同步给 Slave，这样一条消息就不止一份了</li><li>Master 宕机了还有 Slave 中的消息可用，保证了 MQ 的可靠性和高可用性。</li></ol><h2 id="broker-将自己的信息注册到哪个-nameserver-上" tabindex="-1">Broker 将自己的信息注册到哪个 NameServer 上 <a class="header-anchor" href="#broker-将自己的信息注册到哪个-nameserver-上" aria-hidden="true">#</a></h2><ol><li>不是某一个，是全部</li><li>因为 Broker 会向所有的 NameServer 上注册自己的信息，而不是某一个，是每一个。</li></ol><h2 id="消息堆积" tabindex="-1">消息堆积 <a class="header-anchor" href="#消息堆积" aria-hidden="true">#</a></h2><ol><li>先找原因，是 Producer 太多了，Consumer 太少了导致的，还是情况</li><li>一般情况下，通过上线更多 consumer 临时解决消息堆积</li></ol><blockquote><p>如果 Consumer 和 Queue 不对等，上线了多台也在短时间内无法消费完堆积的消息</p></blockquote><ol><li>准备一个临时的 topic</li><li>queue 的数量是堆积的几倍</li><li>queue 分布到多个 Broker 中</li><li>上线一台 Consumer 做消息的搬运工，把原来 Topic 中消息挪到新的 Topic 里， 不做业务逻辑处理，只是挪过去</li><li>上线 N 台 Consumer 同时消费临时 Topic 中的数据</li><li>改 bug</li><li>恢复原来的 Consumer ，继续消费之前的 Topic</li></ol><h2 id="堆积时间过长消息超时了" tabindex="-1">堆积时间过长消息超时了 <a class="header-anchor" href="#堆积时间过长消息超时了" aria-hidden="true">#</a></h2><ol><li>RocketMQ 中消息只会在 commitLog 被删除的时候才会消失，不会超时 也就是说未被消费的消息不会存在超时删除的情况</li></ol><h2 id="死信队列" tabindex="-1">死信队列 <a class="header-anchor" href="#死信队列" aria-hidden="true">#</a></h2><ol><li>正常情况下无法被消费的消息称为死信消息</li><li>RocketMQ 中消息重试超过一定次数后（默认 16 次）就会被放到死信队列中，在消息队列</li><li>场景 <ol><li>平时下单后未在指定时间内付款，过来这个时间，我们的订单会被放入死信队列中， 当我们付款的时候，会发现订单已经被取消，此时我们只需要去死信队列中查该订单是否存在。</li><li>如当一些消息出现异常迟迟未被消费（或者最大重试次数后也未成功消费），这时候就 会将消息存放到死信队列中。</li></ol></li></ol><h2 id="默认端口" tabindex="-1">默认端口 <a class="header-anchor" href="#默认端口" aria-hidden="true">#</a></h2><p>rocketNameServer 9876</p><p>kafka 9092</p><p>zk clientPort=2181 server.1=localhost:2887:3887 server.2=localhost:2888:3888 server.3=localhost:2889:3889 第一个端口，clientPort就是zk服务端暴露出来供zk客户端连接的端口， 之后zk客户端（ssh终端或者java代码客户端）发送命令到服务端都会经过这个端口</p><p>第二个端口，集群列表的最后一列，比如3888，这个就是集群之间进行领导者选举的端口， 在集群刚启动或者集群奔溃恢复的时候，会进行leader选举， 此时，集群中的各个节点会通过该端口交换各自的选票信息</p><p>第三个端口，集群列表的倒数第二列，比如2888，这个就是集群之间进行数据同步的端口， 当领导者刚刚选举成功，follower需要同步leader的最新数据保持一致，或者进行写命令操作时， ZAB协议需要的数据交互，或者各节点之间保持心跳的ping命令交互。</p><h2 id="每个消息至少投递一次" tabindex="-1">每个消息至少投递一次 <a class="header-anchor" href="#每个消息至少投递一次" aria-hidden="true">#</a></h2><ol><li>前提：发送消息阶段，不允许发送重复的消息，消息消费阶段，不允许消费重复的消息。</li><li>只有以上两个条件都满足情况下，才能人物为消息是只被消费一次，要实现以上两点，在分布式系统环境下，不可避免要产生巨大的开销，RocketMQ为了追求高性能，并不保证此特性，要求在业务上进行去重，也就是说消费消息要做到幂等性，Rocket虽然不能严格保证不重复，但是正常情况下很少会出现重复发送，消费情况，只有网络异常，consumet启停等异常情况下会出现消息重复。</li></ol><h2 id="回溯消息" tabindex="-1">回溯消息 <a class="header-anchor" href="#回溯消息" aria-hidden="true">#</a></h2><ol><li>回溯消息是指consumer已经消费成功的消息，由于业务上需求需要重复消费，要支持此功能，broker在向consumer投递成功消息后，消息仍然需要保留，并且重新消费一般是按照时间纬度，例如：由于consumer系统故障，恢复后需要重新消费1小时的数据，那么broker要提供一种机制，可按照时间纬度来回退消费进度。</li><li>rocketMQ支持按照时间回溯消费，时间纬度精确到毫秒，可向前回溯，也可向后回溯</li></ol><h2 id="定时消息" tabindex="-1">定时消息 <a class="header-anchor" href="#定时消息" aria-hidden="true">#</a></h2><ol><li>指消息发到broker后，不能立刻被consumer消费，要到特定的时间点或者特定的时间后才能被消费</li><li>如果要支持任意的时间精度，在broker层面，必须要做消息排序，如果再涉及到持久化，那么消息排序要不可避免的产生巨大性能开销</li><li>rocketMQ支持定时消息，但是不支持任意时间精度，支持特定的level，例如定时5s、10s、1m等</li></ol><h2 id="消息重试" tabindex="-1">消息重试 <a class="header-anchor" href="#消息重试" aria-hidden="true">#</a></h2><p>consumer消费消息失败后，要提供一种重试机制，令消息再消费一次</p><ul><li>a. 由于消息本身的原因，例如反序列化失败，消息数据本身无法处理</li><li>b. 由于依赖的下游应用服务不可用，例如db连接不可用，外系统网络不可达等</li></ul><h2 id="mq-性能优化" tabindex="-1">MQ 性能优化 <a class="header-anchor" href="#mq-性能优化" aria-hidden="true">#</a></h2><blockquote><p><a href="https://blog.csdn.net/tianlangls/article/details/102810463" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/tianlangls/article/details/102810463</a></p></blockquote><p>MQ的性能优化感觉和数据库有一些相同之处，下面我整理了一些比较实用的性能优化：</p><ol><li><p>减少连接数，不应该反复建立与队列管理器的连接和反复进行队列打开/关闭操作，尽量将能一次性处理的操作一次性处理，一起提交</p></li><li><p>尽量减小消息的大小，小消息的读取效率要高，同时要注意MQ每个消息都会有一个消息头，它会占有一定的字节数，所以也不能拆分太小，不同的MQ和业务有其对应的合理值</p></li><li><p>处理一批消息时，一次性一起提交</p></li><li><p>MQ适用于不同类型的应用。不仅可以实现&quot;点对点&quot;的通讯，还t支持&quot;多点广播&quot;应用，所以在将一条消息发送到同一系统上的多个用户或队列时，MQ可以将消息的一个复制版本和该系统上接收者的名单发送到 目标系统。目标系统在本地复制这些消息，并将它们发送到DistributionList上的队列，从而减少了网络的传输量。</p></li><li><p>MQ的消息分为永久性消息和非永久性消息两种，根据需求合理的分配</p></li><li><p>使用多线程来监听通道</p></li></ol></div></div></main><footer class="VPDocFooter" data-v-3886f8ec data-v-4fc1a8f4><div class="edit-info" data-v-4fc1a8f4><div class="edit-link" data-v-4fc1a8f4><a class="VPLink link edit-link-button" href="https://github.com/space2030?tab=repositories" target="_blank" rel="noopener noreferrer" data-v-4fc1a8f4 data-v-8dd034e6><!--[--><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="edit-link-icon" data-v-4fc1a8f4><path d="M18,23H4c-1.7,0-3-1.3-3-3V6c0-1.7,1.3-3,3-3h7c0.6,0,1,0.4,1,1s-0.4,1-1,1H4C3.4,5,3,5.4,3,6v14c0,0.6,0.4,1,1,1h14c0.6,0,1-0.4,1-1v-7c0-0.6,0.4-1,1-1s1,0.4,1,1v7C21,21.7,19.7,23,18,23z"></path><path d="M8,17c-0.3,0-0.5-0.1-0.7-0.3C7,16.5,6.9,16.1,7,15.8l1-4c0-0.2,0.1-0.3,0.3-0.5l9.5-9.5c1.2-1.2,3.2-1.2,4.4,0c1.2,1.2,1.2,3.2,0,4.4l-9.5,9.5c-0.1,0.1-0.3,0.2-0.5,0.3l-4,1C8.2,17,8.1,17,8,17zM9.9,12.5l-0.5,2.1l2.1-0.5l9.3-9.3c0.4-0.4,0.4-1.1,0-1.6c-0.4-0.4-1.2-0.4-1.6,0l0,0L9.9,12.5z M18.5,2.5L18.5,2.5L18.5,2.5z"></path></svg> 在 github 上编辑此页<!--]--><!----></a></div><div class="last-updated" data-v-4fc1a8f4><p class="VPLastUpdated" data-v-4fc1a8f4 data-v-537b088a>最后更新: <time datatime="2023-10-19T07:32:22.000Z" data-v-537b088a></time></p></div></div><!----></footer><!--[--><!--]--></div></div></div></div></div><footer class="VPFooter" data-v-581d5782 data-v-3d0cd5b8><div class="container" data-v-3d0cd5b8><p class="message" data-v-3d0cd5b8>Released under the MIT License.</p><p class="copyright" data-v-3d0cd5b8>Copyright © 2023-present Evan You</p></div></footer><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"f37252e3\",\"src_case_example_aqs抽象队列同步器.md\":\"24756237\",\"src_case_example_arraylist扩容机制解析.md\":\"a4b8bed3\",\"src_case_example_arrays类sort()方法使用的排序算法.md\":\"ccfbb6ab\",\"src_case_example_concurrenthashmap为什么放弃了分段锁.md\":\"0a4ffee0\",\"src_case_example_es与mysql数据不一致.md\":\"d871661c\",\"src_case_example_redis与mysql数据不一致.md\":\"26418c82\",\"src_case_example_tomcat性能优化.md\":\"dfbb266f\",\"src_case_example_中间件设计.md\":\"468e8da7\",\"src_case_example_代码片段.md\":\"925caa6b\",\"src_case_example_分布式事务解决方案.md\":\"2f070cfb\",\"src_case_example_分布式唯一id.md\":\"23eadd1f\",\"src_case_example_分布式锁-基于数据库的实现.md\":\"4d8b29d2\",\"src_case_example_分库分表.md\":\"c52281c2\",\"src_case_example_如何处理千万级别mysql数据库锁表问题.md\":\"b4c0af50\",\"src_case_example_如何快速从千万级大表删除数据.md\":\"91fe5800\",\"src_case_example_批量处理数据.md\":\"78b0d9bb\",\"src_case_example_接口性能优化.md\":\"9d1792f7\",\"src_case_example_架构设计.md\":\"d307ccb7\",\"src_case_example_百万级别数据导入导出如何优化.md\":\"98a549ab\",\"src_case_example_百万级数据深度分页如何优化.md\":\"32c9674d\",\"src_case_example_秒杀.md\":\"fcad5d18\",\"src_case_example_系统设计规范.md\":\"15c311eb\",\"src_case_example_线上环境踩坑之并行流丢失数据.md\":\"1c3be8f9\",\"src_case_example_线程池.md\":\"e4225766\",\"src_case_example_综合面.md\":\"f493e2fa\",\"src_case_example_网络.md\":\"2753f5be\",\"src_case_example_设计接口.md\":\"38f526c0\",\"src_case_example_设计模式.md\":\"47a4706e\",\"src_case_example_重构.md\":\"f8b1bb82\",\"src_case_index.md\":\"e7293aa9\",\"src_case_norm_javascript规范.md\":\"9fb24129\",\"src_case_norm_java规范.md\":\"538dd69a\",\"src_case_norm_markdown规范.md\":\"2b32c5f2\",\"src_case_norm_vue规范.md\":\"898eb012\",\"src_case_norm_前后端规约.md\":\"e89a40a3\",\"src_case_norm_接口对接规范.md\":\"6d91f32f\",\"src_case_norm_日志规范.md\":\"f59ee845\",\"src_case_redis操作.md\":\"2f51e4c7\",\"src_deploy_index.md\":\"6cb4a725\",\"src_deploy_mongodb部署.md\":\"8a227b4a\",\"src_deploy_mysql部署.md\":\"11af5f81\",\"src_deploy_node部署.md\":\"fdf9e10a\",\"src_deploy_oracle部署.md\":\"f730433a\",\"src_deploy_redis部署.md\":\"ad57b569\",\"src_git_index.md\":\"1f809b9a\",\"src_index_index.md\":\"33da6e30\",\"src_kit_blog.md\":\"1c11ac7e\",\"src_kit_index.md\":\"04dd6794\",\"src_kit_nginx.md\":\"5c165844\",\"src_kit_tool.md\":\"d4ebdde9\",\"src_view_index.md\":\"dc64bfa6\",\"src_view_java_java-01-se.md\":\"d50e6d5e\",\"src_view_java_java-02-ee.md\":\"06cece6f\",\"src_view_java_java-03-tomcat.md\":\"4e071e95\",\"src_view_java_java-04-spring.md\":\"294e3736\",\"src_view_java_java-05-mybatis.md\":\"f08a45bf\",\"src_view_java_java-06-spring-boot.md\":\"0aff5c53\",\"src_view_java_java-07-maven.md\":\"cd8805f9\",\"src_view_java_java-08-spring-cloud.md\":\"9b8482f6\",\"src_view_java_java-09-mysql.md\":\"00f74996\",\"src_view_java_java-10-redis.md\":\"07f078ba\",\"src_view_java_java-11-oracle.md\":\"333de976\",\"src_view_java_java-12-gateway.md\":\"d8b6a793\",\"src_view_java_java-13-elasticsearch.md\":\"b01a920e\",\"src_view_java_java-14-mongodb.md\":\"a29b919f\",\"src_view_java_java-15-rocketmq.md\":\"2983da5e\",\"src_view_java_java-16-activemq.md\":\"d2aa5ffd\",\"src_view_java_java-17-rabbitmq.md\":\"ed854218\",\"src_view_java_java-18-zookeeper.md\":\"2bb8ca84\",\"src_view_java_java-19-kafka.md\":\"ef7bf4c5\",\"src_view_web_web-01-html.md\":\"f76a68db\",\"src_view_web_web-02-javascript.md\":\"560f2ce1\",\"src_view_web_web-03-vue.md\":\"e6cb6cc4\",\"src_web_index.md\":\"4759f761\",\"src_web_vitepress_vitepress快速开始.md\":\"86859a47\",\"src_web_vitepress_vitepress语法规则.md\":\"e4ba6974\",\"src_web_vitepress_vitepress项目发布.md\":\"246085db\"}")</script>
    <script type="module" async src="/vitepress-deploy/assets/app.2a154df8.js"></script>
    
  </body>
</html>